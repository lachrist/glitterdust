<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>GlitterDust-Batch</title>
    <style>#main {
  font-family: Helvetica, 'Open Sans', Arial, sans-serif;
  font-weight: lighter;
  width: 1000px;
  margin: auto;
}

h1 {
  text-align: center;
}

p {
  text-align: justify;
}

table {
  margin: 10px;
}

button {
  padding: 8px;
  margin-bottom: 30px;
  margin-right: 20px;
  font-size: 14px
}

button::-moz-focus-inner {
  padding: 8px;
}

table, th, td {
  border: 1px solid black;
  border-collapse: collapse;
}

th, td {
  padding: 5px;
}
</style>
    <script>require=(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){

// node ../run.js --mode batch --out ./batch.html --instrument ./multiply.js --masters ./masters --targets ./targets --help

module.exports = function (master, target) { return Array(Number(master)+1).join(target) }

},{}],2:[function(require,module,exports){

exports.round = function (x) { return Math.round(1000*x)/1000 }

exports.print = function (x) { return (typeof x === "string") ? JSON.stringify(x) : String(x) }

exports.benchmark = function (code) {
  var out = {};
  out.loc = code.split("\n").length;
  out.time = performance.now();
  try { out.result = window.eval(code) }
  catch (e) { out.error = e }
  out.time = performance.now()-out.time;
  return out;
}

},{}],"glitterdust":[function(require,module,exports){

var Instrument = require("/Users/soft/Desktop/workspace/glitterdust/test/multiply.js");
var Util = require("../util.js");
var dom = {};
var interval = null;

/////////
// DOM //
/////////

module.exports = function () {
  // cache //
  dom.run = document.getElementById("run");
  dom.stop = document.getElementById("stop");
  dom.masters = document.getElementById("masters");
  dom.targets = document.getElementById("targets");
  dom.list = document.getElementById("list");
  // bind //
  dom.stop.onclick = stop;
  dom.run.onclick = run;
  toggle(true);
  benchmarkall({"x0.txt":"0","x1.txt":"1","x2.txt":"2","x3.txt":"3"}, {"fac.js":"\nfunction fac (n) { return n ? n*fac(n-1) : 1 }\nfac(150);\n","fibo.js":"\nfunction fibo (n) { return n<=1 ? n : fibo(n-1)+fibo(n-2) }\nfibo(40);\n"});
}

function toggle (d) {
  dom.masters.disabled = d;
  dom.targets.disabled = d;
  dom.run.disabled = d;
  dom.stop.disabled = !d;
}

/////////////////
// Run && Stop //
/////////////////

function run () {
  toggle(true);
  while (dom.list.firstChild)
    dom.list.removeChild(dom.list.firstChild);
  var masters = {};
  var targets = {};
  var rdv = 0;
  function read (file, dico) {
    rdv++;
    var reader = new FileReader();
    reader.readAsText(file, "UTF-8");
    reader.onload = function () {
      dico[file.name] = reader.result;
      if (--rdv === 0)
        benchmarkall(masters, targets);
    }
  }
  for (var i=0; i<dom.masters.files.length; i++)
    read(dom.masters.files[i], masters);
  for (var i=0; i<dom.targets.files.length; i++)
    read(dom.targets.files[i], targets);
  if (rdv === 0)
    benchmarkall(masters, targets);
}

function stop () {
  clearInterval(interval);
  toggle(false);
}

///////////////
// Benchmark //
///////////////

function benchmarkall (masters, targets) {
  var tks = Object.keys(targets);
  var mks = Object.keys(masters);
  var tidx = -1, midx = mks.length;
  var results = {};
  var table = null;
  interval = setInterval(function () {
    console.log(tidx+":"+midx)
    if (midx === mks.length) {
      midx = 0;
      tidx++;
      if (tidx === tks.length) {
        console.log()
        stop();
      } else {
        table = make.table();
        var li = document.createElement("li");
        li.textContent = tks[tidx];
        li.appendChild(table);
        dom.list.appendChild(li);
        var out = Util.benchmark(targets[tks[tidx]]);
        out.masters = {};
        table.appendChild(make.row("", out.loc, Util.print(out.result), Util.print(out.error), Util.round(out.time), ""));
        results[tks[tidx]] = out;
      }
    } else {
      try {
        var out = Util.benchmark(Instrument(masters[mks[midx]], targets[tks[tidx]]));
        var slowdown = out.time / results[tks[tidx]].time;
        results[tks[tidx]].masters[mks[midx]] = out;
        table.appendChild(make.row(mks[midx], out.loc, Util.print(out.result), Util.print(out.error), Util.round(out.time), Util.round(slowdown)));
      } catch (e) {
        alert("Error while instrumenting "+tks[tidx]+" with master "+mks[midx]+": "+e);
      }
      midx++;
    }
  }, 100);
}

/////////////
// Display //
/////////////

var headers = ["Master", "LoC", "Result", "Error", "Time", "Slowdown"];
var make = {};
make.table = function () {
  var table = document.createElement("table");
  var th = document.createElement("tr");
  table.appendChild(th);
  for (var i=0; i<headers.length; i++) {
    var td = document.createElement("th");
    td.textContent = headers[i];
    th.appendChild(td);
  }
  return table;
}
make.row = function () {
  var tr = document.createElement("tr");
  for (var i=0; i<arguments.length; i++) {
    var td = document.createElement("td");
    td.textContent = arguments[i];
    tr.appendChild(td);
  }
  return tr;
}

// function report (results) {
//   var time = 0;
//   var arantime = 0;
//   results.forEach(function (res) {
//     time += res.time;
//     arantime += res.arantime;
//   });
//   var report = "Slowdownfactor >> average: "+round(arantime/time);
//   results = results.sort(function (r1, r2) { return (r1.arantime/r1.time) > (r2.arantime/r2.time) });
//   var res;
//   report += ", first quartil: "+(res=results[Math.round(results.length/4)],res.arantime/res.time);
//   report += ", median:"+(res=results[Math.round(results.length/2)],res.arantime/res.time);
//   report += ", third quartil: "+(res=results[Math.round(3*results.length/4)],res.arantime/res.time);
//   dom.feedback.textContent = report;
//   toggle(false);
// }

},{"../util.js":2,"/Users/soft/Desktop/workspace/glitterdust/test/multiply.js":1}]},{},[]);

window.onload = require('glitterdust');</script>
  </head>
  <body>
    <main id="main">
      <ul>
        <li><label>Masters: <input id="masters" type="file" id="input" multiple></label></li>
        <li><label>Targets: <input id="targets" type="file" id="input" multiple></label></li>
      </ul>
      <button id="run">Run</button>
      <button id="stop">Stop</button>
      <ul id="list"></ul>
    </main>
  </body>
</html>
